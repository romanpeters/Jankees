---
- name: Add user jenkins
  ansible.builtin.user:
    name: jenkins
    state: present
    password: '!'

- name: Read the fetched SSH key
  ansible.builtin.slurp:
    src: /tmp/ansible/id_rsa.pub
  register: ssh_key
  delegate_to: localhost

- name: Add jenkins to authorized hosts
  ansible.posix.authorized_key:
    user: jenkins
    state: present
    key: "{{ ssh_key['content'] | b64decode | string }}"
  become: true

- name: Add passwordless sudo
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    state: present
    create: true
    mode: 0440
    line: "jenkins		ALL=(ALL:ALL) NOPASSWD:ALL"
    validate: /usr/sbin/visudo -cf %s
  become: true
  
- name: Add jenkins to docker group
  ansible.builtin.user:
    name: jenkins
    groups: docker
    append: true
  when: "'docker' in group_names"

